
siggy2.Dialog = siggy2.Dialog || {};

siggy2.Dialog.StructureVulnerability = function(core, structure)
{
	this.templateDialog = Handlebars.compile( $("#template-dialog-structure-vulnerability").html() );
	this.templateAdder = Handlebars.compile( $("#template-dialog-structure-vulnerability-form").html() );
    this.core = core;
	this.structure = structure;
	
	var $this = this;

	var content = $this.templateDialog($this.structure);
	this.dlg = siggy2.Dialogs.dialog({
							title: "Structure Vulnerability",
							content: content,
							id: "dialog-structure-vulnerability-"+this.structure.id,
							buttons:{
								save: {
									text: "Save Changes",
									style: 'primary',
									disabled: true,
									callback: function(dialog) {
										$this.saveChanges();
										
										dialog.hide();
										$this.destroy();
									}
								},
								close: {
									text: "Close",
									style: 'danger',
									callback: function(dialog) {
										dialog.hide();
										$this.destroy();
									}
								},
							}
						});
	
	this.defaultAdderData = {
		model: {
			days: 0,
			hours: 0,
			minutes: 0,
			seconds: 0
		}
	};
	
	this.adderFormConstraints = {
		days: {
			presence: true,
			numericality: true
		},
		hours: {
			presence: true,
			numericality: true
		},
		minutes: {
			presence: true,
			numericality: true
		},
		seconds: {
			presence: true,
			numericality: true
		},
	};
}

siggy2.Dialog.StructureVulnerability.prototype.show = function()
{
	this.dlg.show();
	var $this = this;

	$('#vulnerability-adder-'+this.structure.id).html(this.templateAdder(this.defaultAdderData));
	$('#vulnerability-adder-'+this.structure.id).on('submit','form',function(ev){
    	ev.stopPropagation();
		ev.preventDefault();
		
		$this.handleAdderSubmit();
		return false;
	});

	this.table = new siggy2.VulnerabilityTable('#structure-vuln-table-'+this.structure.id, function(){	
		$this.dlg.enableButton('save');
	});
	this.table.import(this.structure.vulnerabilities);
}

siggy2.Dialog.StructureVulnerability.prototype.handleAdderSubmit = function()
{
	var formData = $('#vulnerability-adder-'+this.structure.id+' form').serializeObject();

	var errors = validate(formData, this.adderFormConstraints);

	var data = {
		model: formData,
		errors: errors
	};
	
	if(siggy2.isDefined(errors))
	{
		$('#vulnerability-adder-'+this.structure.id).html(this.templateAdder(data));
		return;
	}
	
	this.dlg.enableButton('save');
	this.table.addFromTimer(parseInt(formData.days), parseInt(formData.hours), parseInt(formData.minutes), parseInt(formData.seconds));
}

siggy2.Dialog.StructureVulnerability.prototype.saveChanges = function()
{
	var data = {
		id: this.structure.id,
		vulnerabilities: this.table.export()
	};

	$.post(this.core.settings.baseUrl + 'structure/vulnerabilities', JSON.stringify(data))
		.done(function(respData) {
			$(document).trigger('siggy.updateRequested', true );
		})
		.fail(function(jqXHR) {
			if(jqXHR.status >= 500)
			{			
				siggy2.Dialogs.alertServerError("saving the vulnerability timers");
			}
		});
}


siggy2.Dialog.StructureVulnerability.prototype.destroy = function()
{
	this.table.destroy();
}

